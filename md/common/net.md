### 概念 -- 文字和图片主要来自于书籍《计算机网络自顶向下网络》
1. Internet:因特网是一个世界范围的计算机网络，互联了遍及全世界的计算设备的网络。所有的设备都被称为主机或者端系统，端系统通过通信链路和接口交换机连接在一起。
2. 通信链路：由不同的物理媒体组成，包含同轴电缆，铜线，光纤和无线电频谱。不同的链路以不同的速率传输数据，单位一般用bps来表示。
3. 传输流程：
   1. 当端A要向端B发送数据时，端A将数据分段，每段加上首部字节，这样的数据称为分组。
   2. 分组交换机从它的一条通信链路接受不了到达的分组，并从它的另一条通信链路转发该分组。
   3. 一个分组所经历的一系列通信链路和分组交换机称为通过该网络的路径。
   4. 如果将传输过程和现实世界的交通做比喻，端系统类比建筑物，通信链路类比公路/铁路，分组交换机类似于立交桥。
   5. 最出名的分组交换机是路由器和链路层交换机。
   6. 端系统通过因特网提供商（Internet Service Provider ISP）接入因特网。
4. ISP（Internet Server Provider）：因特网提供商
   1. 每个ISP是由多个分组交换机和多段通信链路组成的网络。
   2. 不同ISP为端系统提供了不同类型的网络接入，例如56kbps调制解调器接入/线缆调制解调器提供的住宅宽带接入/高速局域网接入/无线接入等。
   3. 底层的ISP通过国家的/国际的高层ISP连接在一起。
   4. 高级ISP由高速光纤链路互联的高速路由器组成。
   5. 无论是高层ISP，还是低层ISP，都是独立管理的，运行IP协议，准从一定的命名和地址习惯。
5. TCP/IP:因特网最重要的2个协议
   1. TCP： Transmission Control Protocol 传输控制协议
   2. IP： Internet Protocol 网际协议
6. IETF （Internet Engineering Task Force）:因特网工程任务组
   1. 研发因特网标准
   2. IETF的文档被称为请求评论（RFC，Request For Comment）
7. API（Application Programming Interface）：应用程序接口
   1. 由端系统提供
   2. 规定了运行在一个端系统上的软件请求因特网基础设施向运行在另一个端系统上的特定目的地软件交互数据的方式
8. 协议：定义了在2个或多个通信实体之间交换的报文格式和次数，以及在报文传输或接受，或其他事件方面所采取的动作
9. End System：端系统，位于因特网的边缘。也称为主机，主机有时候分为2类
   1. 客户机：
   2. 服务器：
10. Access network：接入网，将端系统连接到边缘路由器的物理链路
    1. 住宅接入
       1. 通过普通模拟电话线（双绞铜线）使用拨号调制解调器与住宅ISP相连；（质量参差不齐，传输速率慢，远小于56kbps）
       2. 数字用户线：一般是电话公司提供，有时有独立的ISP；
       3. 混合光纤同轴电缆
       4. 卫星接入，如StarBand，HughesNet等服务商
    2. 公司接入：在公司和校园，局域网LAN通常被用于连接端用户和边缘路由器
    3. 无线接入
       1. 无线局域网：用户与位于几十米半径内的基站之间传输/接收分组；基站与有线的因特网连接
       2. 广域无线接入网：分组基于用于蜂窝电话的相同无线设施进行发送，基站由电信服务商提供。服务范围可达数万米
11. Edge Router：边缘路由器：是端系统到任何其他远程端系统的路径上的第一台路由器
12. Digital Subscriber Line （DSL）：数字用户线
    1. 一种新型调制解调技术，也运用在双绞线电话线上
    2. 通过限制用户和ISP之间的距离，DSL能以高很多的速率获取和传输数据
    3. ISP到家庭路由的速率比家庭到ISP高得多（设计理念：接收多于发送）
    4. DSL在家庭和ISP之间将通信链路分为3个频段
       1. 高速下行通道，50KHZ-1MHZ
       2. 中速上行通道，4KHZ-40KHZ
       3. 普通双向电话通道，0-4KHZ
13. Hybrid Fiber-coaxial Cable（HFC）：混合光纤同轴电缆 ![图例](../img/net/net-HFC.png)
    1. HFC扩展了用于广播电视电视的网络
    2. 在传统的电缆系统中，电缆头端广播通过同轴电缆和放大器的分配网络传向住宅
    3. HFC需要特殊的调制解调器，称为电缆调制解调器（一种外部设备，通过以太网端口和家庭网络相连）。它将HFC分为了2个通道，下行通道比上行通道拥有更快的传输效率。
    4. HFC的一个重要特征是它共享广播媒体；
14. 频分多路复用技术
15. 以太网
    1. 速度达到100Mbps或1Gbps
    2. 使用双绞铜线或者同轴电缆连接
    3. 使用共享媒体
16. 基于IEEE 802.11实现的无线局域网，也称为无线因特网或WIFI
17. 物理媒体：
    1. 导引型媒体：电波沿固定媒体（如光缆，双绞铜线，同轴电缆）被导引
       1. 双绞铜线：
          1. 最便宜，最普遍。
          2. 由2根1mm粗，隔离的铜线以规则的螺旋排列着。绞合后可减小对临近双绞线电气的干扰。通常许多双绞线捆扎在一起，并用防护型保护层覆盖组成一根电缆。一对电线构成一个通信链路。
          3. 非屏蔽双绞线常用在建筑物内的计算机网络（即无线网），传输速率取决于线的厚度以及传输双方的距离，通常在10Mbps-1Gbps之间。
       2. 同轴电缆
          1. 由2个铜导体组成，同心而非并行。
          2. 能被用作导引式共享媒体，许多端系统能直接和它相连，而且所有的端系统都能接收到由其他端发送的东西
       3. 光缆
          1. 是一种细而柔软，能引导光脉冲的媒体。其中一个脉冲表示一个比特
          2. 速度能高达数十，甚至上百Gbps
          3. 他们不受电磁干扰，长达100km的光缆信号衰减极弱，并且很难接头。（跨海链路首选）
    2. 非导引型媒体：电波在空气或外层空间（如无线局域网，卫星频道）被导引
       1. 陆地无线电信道
           1. 无线电信道承载电磁频谱的信号，不需要物理线路
           2. 具有穿透墙壁，提供与移动用户的连接以及长距离承载信号的能力；但因爱与传播环境和传输信号的距离
           3. 路径损耗/遮挡衰落（阻碍物体会使信号降低）/多径衰弱（干扰对象的信号反射）/干扰（其他无线电信道或电磁信号）
           4. 分类
              1. 运行在本地区域，通常跨越数十到几百米；如无线LAN技术
              2. 运行在广域，跨越数万米；如蜂窝接入
       2. 卫星无线电信道
          1. 一颗通信卫星连接2个或多个位于地球的微波发送方/接收方，他们被称为地面站
          2. 该卫星在一个频段上接收传输，使用一个转发器再生信号，并在另一个频率上上传输信号
          3. 能提供Gbps的带宽
          4. 分为同步卫星和低地球轨道卫星
             1. 同步卫星：永久停留在地球上方相同的点上。该卫星放置在地球表面上方的36000km的轨道，280ms的时间延迟
             2. 低地球轨道卫星围绕地球旋转，类似月球；为了提供对一个区域的连续覆盖，需要在轨道放置许多卫星
18. Optical Carrier （OC）：光载波
    1. 标准速率在51.8Mbps-39.8Gbps，称为OC-1；OC-n表示51.8Mbps*n的链路速率
19. circuit switching：电路交换 ![示意图](../img/net/net-circuit-switching.png)
    1. 上图中，用4条链路互联4台电路交换机。这些链路每条都有n条链路，支持n条电路同时连接。
    2. 当2台主机通信时，该网络在主机之间创建一条专用的端到端连接。连接期间，该连接获得该链路带宽的1/n部分
    3. 电路多路复用 ![示意图](../img/net/net-ft-division-multiplexing.png)
       1. 频分多路复用（Frequency-Division Multiplexing FDM）
          1. 链路的频谱由跨越链路的所有连接共享
          2. 该链路在连接期间为每条连接专用一个频段
          3. 在电话网络中，该频段具有4kHz
          4. 该频段的宽度称为带宽
       2. 时分多路复用（Time-Division Multiplexing TDM）
          1. 时间被划分固定区间的帧；每帧又被划分为固定数量的时隙
          2. 该链路在每个帧中为该连接指定一个时隙
          3. 一个电路的传输速率等于时隙的比特数乘以该帧的速率。如果电路每秒传输8000帧，每个帧由8000比特组成，则一条电路的传输速率为64kbps
       3. 总结：FDM中每条电路连续的获得部分带宽，TDM每条电路在简短的时间间隔中周期性的得到所有带宽
    4. 例如电话网络：该网络必须在发送方和接收方建立一个连接，该路径上交换机都将为该连接维护连接状态，也预留了恒定的连接期间的传输速率
    5. 传输时间与链路数量无关
20. packet switching：分组交换![示意图](../img/net/net-packet-switching.png)
    1. 各种程序在完成其任务的时候要交换报文（任何数据）
    2. 原主机将长报文分为较小的数据块，并称之为分组
    3. 分组以该链路的最大传输速率传输（通信链路+分组交换机）
    4. 多数分组交换器在链路的输入端使用存储转发传输机制。
    5. 分组交换器有多条链路与之相连，对于每条链路，它有一个输出缓存（输出队列），存储着路由器准备发往那条链路的分组。如果到达的分组需要跨越链路传输，但发现该链路正忙于传输其他分组，该到达分组必须在输出缓存中等待
    6. 除了储存转发时延，还有输出缓存的排队时延。时延有波动，取决于网络中的拥塞水平。因为缓存空间大小有限，所以当达到的分组被等待传输的分组完全充满时，将出现分组丢失或丢包。可能是到达的分组，也可能是已经排队的分组之一将被丢弃。
    7. 举例6：餐馆服务员告知你，已经有太多人等待就餐，你必须离开餐馆（这个ð很形象。。）
21. 存储转发传输机制
    1. 概念：交换机能够开始向输出链路传输该分组的第一个比特之前，必须接收到整个分组
    2. 存储转发传输机制 导致 存储转发时延
22. 电路交换和分组交换
    1. 在电路交换中，沿着端系统通信路径，为端系统之间通信所提供的资源（缓存，链路传输速率）在通信会话之间会被预留。而分组网络不会
    2. 电路交换相当于预定，分组交换相当于实时尝试；分别代表是电话网络和因特网网络
    3. 分组交换这种按需分配，而非按预分配共享资源有时被成为资源的统计多路复用（statistical multiplexing）
    4. 趋势向分组交换发展
23. 分组怎么通过分组交换形成通路的？
    1. 每个通过网络传输的分组在它的首部包含了其目的地址
    2. 当路由器到达一台路由器时，该路由器检查分组的目的地址的一部分，并向相邻路由器转发该分组
    3. 每台路由器具有一个转发表，用于将目的地址（或目的地址的一部分）映射到输出链路
24. 选路协议：它们用于自动设置转发表
25. ISP层次 ![ISP和因特网主干](../img/net/net-ISP.png)
    1. 第一层ISP，也被成为因特网主干网络
       1. 数量较少，包括Sprint，Verizon，MCI，AT&T，NTT，Level3，Qwest，Cable&Wireless
       2. 传输速率较高，链路速率通常是622Mbps或更高，大型第一层ISP可达2。5-10Gbps，响应的路由器也必须能以极高的速率转发分组
       3. 特性
          1. 直接与其他每个第一层ISP相连
          2. 与大量的第二层Isp和其他客户网络相连
          3. 覆盖国际区域
    2. 第二层ISP，通常具有区域性质或国家性覆盖规模，并且非常重要的与少数第一层ISP相连
       1. 它被成为是它所连接的第一层ISP的客户，第一层ISP相对于它来说是提供商
       2. 第二层ISP可以选择与其他第二层ISP限量，不必流经第一层ISP
       3. 某些复杂情况下，某些第一层提供商也是第二层提供商，它向较低层次ISP出售因特网接入，也直接向端用户和内容提供商出售因特网接入。当2个ISP直接相连时，他们被称为彼此是对等的
    3. 某ISP与其他ISP的连接点（可以在不同层次）被称为汇集点（Point of Presence,POP）
26. 分组交换网的时延、丢包和吞吐量
    1. 节点时延（以下四种累加起来就是节点总时延）![ISP和因特网主干](../img/net/net-delay.png)
       1. 节点处理时延（nodal processing delay）
          1. 检查分组首部和决定将该分组所需要的时间（主要部分）
          2. 检查比特级差错所需要的时间（微秒甚至更低）
       2. 排队时延 (queuing delay)
          1. 当分组在链路上等待传输时，它经受排队时延（通常在毫秒到微秒级）
          2. 取决于流量到达该排队的性质，链路的传输速率和到达流量的性质（周期、突发）
          3. 计算
             1. 假设米秒到达分组为a pkt/s
             2. 假设每个分组都有L比特组成
             3. 假设传输速率为R bps
             4. 那么x=La/R被称为流量强度 
                1. 如果x>1，那么比特叨叨队列的平均速率超过该队列传输出去的速率，队列的增加将趋向于无穷大。⚠️  
                2. ![平均流量时延和流量强度的关系](../img/net/net-queuing-delay.png)
          4. 丢包：流量强度趋近于1时，因为排队容量有限，排队时延不会趋向于无穷大。分组发现将达到一个满的队列，没有地方存储它，路由器将丢弃该分组。
          5. 节点性能要根据时延和丢包率来衡量
       3. 传输时延（存储转发时延，通常在毫秒到微秒级）(transmission delay)
       4. 传播时延(propagation delay)
          1. 取决于物理媒体
          2. 2-3✖️10的8次方，略低于光速。time=distance/speed
          3. 通常在毫秒级
       5. 传输和传播时延的区别
          1. 前者是路由器将分组推出所需的时间，他是分组长度和链路传输速率的函数，与路由器间距无关
          2. 后者是一个比特从一台路由器向另一台路由器传播所需要的时间，它是距离的函数，与分组的长度或链路的传输熟虑无关
          3. 例子：2座收费站距离100KM，汽车的时速为100KM/H，通过一座收费站需要12s。时延分别为12s，1h
    2. 端到端时延
       1. 处理时延，传输时延，传播时延
       2. 拨号调制解调器的调制/解码时延（几十毫秒）
       3. 媒体分组化时延（IP语音应用）
27. traceroute :可以指定目标主机后，源主机向目标主机发送N个特殊的分组。
    1. 经历的各个路由器接收到这个特殊分组后，会向源主机发一个短报文，该报文包含路由器的名称和地址
    2. 目标主机收到第N个分组时，他也会返回一个报文。报文包含它发送第一个分组到接受并返回报文经受的时间，也包含路由器的名字和地址
    3. RFC1393标准
    4. Linux命令
    5. http://www.traceroute.org
28. 吞吐量
    1. 瞬时吞吐量
    2. 平均吞吐量
    3. 因特网对吞吐量的限制通常是接入网。因为核心网络具有非常高速率的链路（如果核心网络传输速率低，也会影响到吞吐量）
    4. 另一个影响因素是干扰流量
29. 协议分层和服务模型
    1. HTTP/SMTP等应用层协议通常都是端系统软件实现的
    2. 物理层通常在给定链路相关的网络接口卡（例如以太网或WiFi接口卡）实现
    3. 5层因策网协议栈
       1. 应用层：将位于应用层的信息分组称为报文（message）
       2. 运输层：将运输层分组称为报文段（segment）
       3. 网络层：网络层分组称为数据报（datagram），包含IP协议，选路协议等。但IP是最重要的协议，将因特网连接在一起
       4. 链路层：链路层分组称为帧（frame）
       5. 物理层：将帧的一个一个比特从一个节点移动到下一个节点，该层协议仍然与链路相关，并且进一步链路的实际传输媒体（双绞铜线，单模光纤等）相关
    4. 7层ISO模型 ：应用层 --> 表示层 --> 会话层 --> 运输层 --> 网络层 --> 链路层 --> 物理层
    5. 分层示意图![分层示意图](../img/net/net-service-model.png)
       1. 应用层报文M被传送给运输层
       2. 运输层收取报文，并附上附加信息（运输层首部信息Ht，差错检测比特信息，允许接收端向运输层向上向适当应用程序交付报文的信息），构成运输层报文段
       3. 网络层增加了如源和目的端系统地址等网络首部信息Hn，形成网络层数据报
       4. 链路层收取网络数据报，并增加链路首部信息并创建链路层帧
    6. 如5，可以知晓每一层分组有2种类型的字段：首部字段和有效载荷字段（来自于上一层分组）
30. 网络攻击（因特网设计之初，互相信任）
    1. 将恶意软件放到用户计算机
       1. 蠕虫：无需明显用户交互就能进入设备
       2. 特洛伊木马：隐藏在有用软件中的恶意软件
    2. 攻击服务器和网络基础设施
       1. 拒绝服务（Denial-of-Service DOS）：使合法用户不能使用网络，主机或其他基础设施部分
          1. 弱点攻击
          2. 带宽洪泛（分布式DOS）
          3. 连接洪泛
    3. 分组嗅探：无线传输设备附近放置一台被动的接收机（分组嗅探器），该接收机能得到传输的每个分组的拷贝，这些分组可能包含敏感信息。
       1. 也可用于有线环境
       2. 最好的防御嗅探的方法基本都和密码学有关
       3. 分组嗅探器：Ethereal（Windows/Linux/UNIX/Mac） http://www.awl.com/kurose-ross
    4. ip哄骗：生成任意原地址、分组内容和目的地址的分组，然后将这个人工制作的分组传输到因特网中。这种将虚假原地址的分组注入因特网的能力称为IP哄骗。即决方法是端点鉴别机制
    5. 修改或删除报文（中间人攻击）
31. 端到端原则：因为某种功能必须基于端到端实现，与在较高级别提供这些功能的代价相比，在较低级别上设置设置的功能可能是荣誉或几乎没有价值。
32. 自动重传请求协议（Automatic Repeat reRequest，ARQ）：接收方再收到报文后，回应肯定确认（ACK）和否定确认（NAK），使发送方知道哪些内容被正确接受，哪些内容有误需要重传。基于这种重传机制的可靠数据传输协议称为自动重传请求。它还需要3种协议来处理存在的比特差错
    1. 差错检测
    2. 接收方反馈
    3. 重传
33. 肯定确认：ACK， positive acknowledgment
34. 否定确认：NCK， negative acknowledgment
35. 发送缓存：send buffer
36. 回退N步：GBN Go-Back-N
37. 选择重传：SR
38. 最大报文段长：MSS，maximum segment size。MSS是指报文段里应用层数据的最大长度，不包含TCP首部字段。
39. 最大传输单元：MTU，maximum transmission unit。常见值是1460字节、536字节、或512字节
40. 指数加权移动平均：EWMA，Exponential Weighted Moving Average。TCP使用它计算平均时延
41. 平均往返时延：EstimatedRTT
42. 报文段样本时延：SimpleRTT
43. 偏差时延：DevRTT
44. 显示转发拥塞指示：Explicit Forward Congestion Indication,EFCI
45. 资源管理信元：Resources-Management Cell，RM cell
46. 拥塞指示：congestion indication，CI
47. 无增长：no increase，NI
48. 显示速率：Explicit Rate，RT
49. 加性增/乘性减：Additive-Increase，Multiplicative-Decrease，AIMD算法
50. 恒定比特率：Constant Bit Rate，CBR
51. 可用比特率：Available Bit Rate，ABR
52. 虚电路（Virtual-Circuit，VC）网络
53. 数据报网络（datagram network）
54. 寿命：Time-To_Live，TTL
55. 最大传输单元：Maximum Transmission Unit，MTU
56. 因特网名字与好嘛分配机构：Internet Corporation for Assigned Names and Numbers，ICANN
57. 动态主机配置协议：Dynamic Host Config Protocol,DHCP
58. 网络地址转换：Network Address Translation，NAT
59. 全局选路算法：global routing algorithm
60. 链路状态算法：Link-State，LS
61. 分布式选路算法：decentralized routing algorithm
62. 距离向量算法：Distance-Vector，DV
63. 边界网关协议：Border Gateway Protocol，BGP
64. 自治系统号：Autonomous System Number，ASN
65. 反向路径转发：Reverse Path Forwarding，RPF
66. 距离向量多播选路协议：Distance Vector Multicast Routing Protocol， MDVMRP
67. 协议无关的多播选路协议 ：Protocol-Independent Multicast,PIM
68. 源特定多播：Source-Specific Multicast，SSM
69. 多播源发现协议：Multicast Source Discovery Protocol，MSDP
70. 局域网：Local Area Network，LAN
71. 混合光纤电缆：Hybrid Fiber-coaxial Cable，HFC
72. 媒体访问控制：Medium Access Control，MAC
73. 网络接口卡：Network Interface Card，NIC
74. 前向纠错：Forward Error Correction，FEC
75. 循环冗余检测：Cyclic Redundancy Check，CRC

### 网络模型-应用层
1. 通信架构![应用层通信架构](../img/net/net-application-layer.png)
   1. 客户机/服务器体系结构![bs通信架构](../img/net/net-bs.png)
   2. 对等体系结构（P2P）![p2p通信架构](../img/net/net-p2p.png)
      1. 自扩展性，成本有效
      2. 高度分布和开发，具有安全隐患
2. 进程通信
   1. 进程通过一个称为套接字（应用程序编程接口 API）的软件接口在网络上发送和接收报文。开发者对于运输层控制仅限于：
      1. 选择运输层协议
      2. 也许‼️能设定几个参数，如最大缓存，最大报文段长度
3. 分类：
   1. 按可靠性：可靠数据传输/容忍丢失的应用
   2. 按吞吐量：带宽敏感的应用/弹性应用
   3. 时间敏感（准时，一定时延）
   4. 安全
4. 传输服务
   1. TCP
      1. TCP服务模型包含面向连接服务和可靠性数据传输服务，还具有拥塞控制机制
         1. 面向连接服务：之所以是面向连接服务，而不是连接服务，是因为2个进程间是以一种非常松散的方式进行连接的。TCP连接是全双工的
         2. 可靠数据传输服务：无差错，适当顺序。没有字节的丢失和冗余
      2. TCP是明文传输的，所以后续在应用层实现了TCP的加强版本，称为安全套接字（Secure Socket Layer SSL），它提供了额外功能
          1. 加密
          2. 数据完整性
          3. 端点鉴别
   2. UDP 
      1. 是一种不提供不必要服务的轻量级运输层协议，仅提供最小服务
      2. 没有握手过程，无连接
      3. 提供的是不可靠数据传输服务
      4. 不保证该报文能够被接收到，也不保证接收到的顺序
   3. 不提供的服务：图度量和定时保证
   4. 进程寻址：需要定义2种信息去识别接收进程
      1. 该主机的名称或地址（IP地址）
      2. 用来指定目的主机上接收进程的标识（端口号）
5. 应用层协议：定义了运行在不同端系统上的应用程序进程如何相互传递报文。如
   1. 交换的报文类型，如请求报文和响应报文
   2. 各种报文类型的预发，如报文各个字段及其详细描述
   3. 字段的语义
   4. 进程何时、如何发送报文及对报文进行响应的规则
6. HTTP
   1. 超文本传输协议，是Web的核心，在RFC 1945和RFC 2616进行了定义，由客户机和服务器程序2部分组成。
   2. 概念
      1. Web页面，也叫文档，由对象组成
      2. 对象简单来说就是文件，如Html文件，Jpeg图形文件等，这些文件可通过一个URL寻址
      3. URL由服务器主机名和对象的路径名组成
      4. Web服务器用于存储Web对象，每个对象由URL寻址
      5. 无状态协议
      6. 持久连接
      7. 非持久连接：每个TCP连接只传输一个请求报文和一个响应报文。如果个Web页面包含1个HTML，10张图片，那么需要建立11个TCP连接。
      8. 往返时间（Round-Trip Time RTT)
   3. 请求报文格式：
      1. 第一行叫做请求行，包含3部分
         1. 方法字段
            1. GET
            2. POST
            3. PUT
            4. DELETE
            5. HEAD:服务器会用HTTP报文响应，但是不会反悔请求对象。经常用来进行故障追踪
         2. URL字段
         3. HTTP协议版本字段
      2. 其后继的行叫首部行,http可选内容协商首部之一
         1. Connection: close表示浏览器告诉服务器请求响应后关闭连接
         2. User-agent： 定义用户代理，表示浏览器类型
         3. Accept-language： 用户想要得到的语言版本
      3. 常规格式：![http请求报文通用格式](../img/net/net-http-request.png)
      ```text
          GET /somedir/page.html HTTP/1.1
          Host: www.someschool.edu
          Connection: close
          User-agent: Mozilla/4.0
          Accept-language: fr
      ```
   4. 响应报文格式
      1. 状态行
         1. 协议版本
         2. 状态吗
         3. 相应状态信息
      2. 首部行
      3. 实体主体
      4. 常规格式：![http响应报文通用格式](../img/net/net-http-response.png)
   5. 用户与服务器的交互：cookie，其标准在RFC 2109中定义。cookie由4部分组成
      1. 用户端系统保留有一个cookie文件，由浏览器管理 
      2. http请求报文中有一个cookie首部行 
      3. http响应报文中有一个cookie首部行 
      4. web站点有一个后端数据库
      5. 示意图：![http cookie示意图](../img/net/net-http-cookie.png)
   6. Web缓存器（Web cache），也叫代理服务器，它是能够代码出事Web服务器来满足Http请求的网络实体
      1. 它有自己的磁盘存储空间，并保存最近请求过的对象的拷贝
      2. 既是服务器，又是客户机
      3. 问题点：缓存器的对象可能是陈旧的
   7. 条件GET方法：允许缓存器证实它的对象是最新的
      1. header添加 If-modified-since:velue为服务器上次接口响应的 Last-modified的值。如果对象没有更新，服务器将不会返回请求数据，而是返回状态码304标识对象未修改
7. 文件传输协议FTP
   1. FTP使用2个并行的TCP连接来传输文件
      1. 控制连接：传输控制信息，如用户标识、口令、改变远程目录的命令、"put"和"get"文件的命令
      2. 数据连接：实际传输文件。
      3. 因为FTP使用分离的控制连接，所以称FTP的控制信息是带外（out-of-band）的，类似的还有音视频连接的RTSP协议。对应的，Http属于带内发送控制信息
      4. 每次传输文件，FTP都会打开新的数据连接
      5. FTP在会话期间会保留用户的状态。对着用户在远程目录上移动，服务器必须追踪用户在远程目录树上的位置。对每个活动用户状态进行追踪，可以对FTP会话总数做限制
   2. FTP命令（详情减RFC 959）
      1. 请求
         1. USER username：用于向服务器传送用户标识
         2. PASS password：用户向服务器传送用户口令
         3. LIST： 用户请求服务器返回远程主机当前目录的所有文件列表
         4. RETR filename：用户从远程主机的但该案目录检索（get）文件。该命令触发远程主机发起一个数据连接，并在该数据连接上发送所请求的文件
         5. STOR filename：用于向远程主机的当前目录存放（put）文件
      2. 响应
         1. 331：用户名正确，请输入密码
         2. 125：传送文件开始
         3. 425：不能建立连接
         4. 452：写文件错误？
8. 电子邮件![电子邮件示意图](../img/net/net-email.png)
   1. 组成：
      1. 用户代理（user agent）
      2. 邮件服务器（mail server）
      3. 简单邮件传输协议（Simple Main Transfer Protocol SMTP）
   2. SMTP
      1. RFC可以追溯到1982年，当时SMTP已经出现一段时间
      2. 限制请求报文的主体部分只能采用简单的7位ASCII码表示。如果发送多媒体需要有一个编码/加码过程
      3. 传输过程![电子邮件传输示意图](../img/net/net-smtp-transfer.png)
      4. SMTP是持久连接
      5. 命令举例：
         1. HELO
         2. MAIL FROM
         3. RCPT TO
         4. DATA
         5. QUIT
      6. 和Http的区别
         1. HTTP主要获取信息，SMTP主要推送文件
         2. SMTP要求每个保温杯都是7位ASCII码格式
         3. 对于包含文本和图形（或其他媒体），http会把所有报文放在http的响应报文，电子邮件则把所有报文对象放在一个报文中
      7. 报文：
         ```text
            From：
            To：
            Subject：
            空行
            正文
         ```
   3. 邮件报文格式和MIME
      1. 在RFC 822中定义
      2. 早期的邮件对格式限制太严格，多用途因特网邮件扩展（Multipurpose Internet Mail Extension MIME）是对RFC 822进行了扩展
   4. 邮件访问协议
      1. 第三版的邮局协议（Post Office Protocol-Version 3 POP3）
         1. 客户打开一个到服务器端口110的TCP连接
         2. POP按照3个结算进行工作
            1. 特许（以明文发送用户名和口令以鉴别哦那个户）
            2. 事务处理（用户取回报文），可选操作包括
               1. 对报文做删除标记
               2. 取消报文删除标记
               3. 获得邮件的统计信息
            3. 更新（它在客户机发出quit命令后，结束POP3会话。这时，邮件服务器会删除标记的报文）
         3. 事务处理过程（RFC 1939）
            1. 使用POP3的用户通常由用户配置为"下载并删除"或者"下载并保留"
            2. POP3代理会根据用户配置决定发出什么命令
               1. 如果是下载并删除，代理会发出list、retr、dele、quit命令
      2. 因特网邮件访问协议（Internet Mail Access Protocol IMAP）
         1. IMAP将每个报文和文件夹联系起来，客户可以创建文件夹、移动、阅读、删除邮件
         2. IAMP提供了允许用户代理获取报文组件的命令，可以只读取一个报文的报文首部，或者一个多方MIME报文的一部分
      3. Http：用户和服务器使用HTTP，服务器和服务器使用SMTP
9. DNS：因特网的目录服务（Domain Name System）
   1. 定义
      1. 一个由分层的DNS数据实现的分布式数据库
      2. 一个允许主机查询分布式数据库的应用层协议
   2. DNS通常运行是BIDN（Berkeley Internet Name Domain）软件的UNIX机器
   3. DNS协议运行在UDP上，使用53端口
   4. 其他服务
      1. 主机别名
      2. 邮件服务器别名
      3. 负载分配
   5. DNS分层![DNS分层示意图](../img/net/net-dns-layer.png)
      1. 根DNS服务器
      2. 顶级域DNS服务器（Top-Level Domain TLD）
      3. 权威DNS服务器
      4. 本地DNS服务器（并不属于DNS服务器的层次结构） 
   6. 调用流程![DNS调用示意图](../img/net/net-dns-flow.png)
   7. DNS缓存
   8. DNS记录和报文
      1. 概念：实现DNS分布式数据的所有DNS服务器共同存储这资源记录（Resource Record ，RR），它提供了主机名到IP地址的映射
      2. 格式：\[Name,Value,Type,TTL];type决定了name和value，ttl则是过期时间
         1. Type=A:Name=host,Value=ip
         2. Type=NS:Name=域,value=权威DNS服务器的主机名
         3. Type=MX：Value是别名为Name的邮件服务器的规范主机名
      3. DNS报文：DNS查询和回答报文有相同的格式，如图![DNS调用示意图](../img/net/net-dns-message.png)
      4. DNS报文详解
         1. 前12字节是首部区域，12byte*8=96bit
            1. 第一个16bit用于表示该查询，它会被复制到对应的回答报文中，以便和请求相对应，可以理解为requestId 
            2. 标志字段
               1. 1bit的"查询/回答"标识位，0-查询，1-回答
               2. 如果某DNS服务器正好是被请求主机的权威DNS，会设置1比特的"权威"标识为
               3. 如果客户机（主机或DNS服务器）希望DNS服务器递归查询，将设置1比特的"希望递归"标志位
               4. 如果该服务器支持递归查询，在它的回答报文会对1比特的"递归可用"标志位置位
            3. 还有4和数量字段，指出了首部后4类数据区域出现的数量
         2. 问题区域包含正在进行的查询信息，该区域包括：
            1. 名字字段，用于指出正在被查询的主机名字
            2. 类型字段，用于指出正在被询问的问题类型（A，NS，MX）
         3. 回答区域包含了对最初请求的名字的资源记录，如Type/Name/Value/TTL字段。一条报文可以包含多条RR，因为一个主机名可以对应多个IP地址
         4. 权威区域包含了其他权威DNS服务器的记录
         5. 附加区域包含了一些其他有帮助的记录
      5. DNS测试 nslookup程序
   9. 如何往DNS数据库写入数据
      1. 需要提供基本权威DNS服务器和辅助权威DNS服务器的名字和IP
      2. 向注册登记机构（商业实体，它验证域名的唯一性并入库）注册，该机构确保将一个类型NS和一个类型A的记录输入TLD com服务器。
      3. 假设注册networkutopia.com域名，对应DNS服务器分别为dns1.networkutopia.com和dns2.networkutapia.com,212.212.212.1和212.212.212.212.2
      4. 那么将有2条数据库入库
         1. network.com,dns1.networkutopia.com,NS
         2. dns1.networkutopia.com,212.212.212.1,A
      5. 当用户访问此域名时，用户主机首先向本地DNS服务器发送请求，本地DNS联系TLD服务器（如果TLD服务器没有，必须联系根服务器）。TLD返回这两条资源记录，主机向212.212.212.1获取ip，然后发起连接
   10. DNS攻击
       1. DDoS带宽洪泛攻击
10. P2P应用
    1. 文件分发（BitTorrent协议）
       1. BitTorrent是一种用于文件分发的流行P2P协议。它定义
          1. 参与一个特定文件分发的所有对等方的集合称为一个洪流
          2. 在一个洪流中，对等方彼此下载等长度的文件块，块长通常256KB
          3. 当一个对等方开始加入一个洪流时，它没有对等块，但是随着时间推移，它会累积越来越多的文件块。
          4. 当它下载文件块时，也为其他对等方上传了多个文件块
          5. 当它下载结束后，他可以离开洪流，也可以留在洪流继续上传
          6. 它可以任何时候离开洪流，也可以重新加入
       2. bit torrent实现
          1. 每个洪流具有一个基础设施节点，称为追踪器。
          2. 每个加入洪流的对等方会自动向追踪器注册，并周期性通知追踪器它仍在洪流中
          3. 当一个新的对等方A加入洪流时，追踪器随机从参与对等方的集合选择一些对等方，并将这些ip发送给A。
          4. 当A与这些对等方创建并行的TCP成功后，称A与这些创建TCP连接的对等方为"临近对等方"
          5. ![P2P 示例](../img/net/net-p2p-bit-torrent-simple.png)
          6. A将周期性的询问对等方它们具有的"块列表"，而后确定向"哪个邻居"请求"哪个块"？（使用最稀罕优先机制）
          7. 该协议采用的机制
             1. 最稀罕优先：根据当前对等方没有的块，判定哪些是邻居中拷贝数量最少的块。这个算法的目的是均衡每个块在洪流中的拷贝数量
             2. 对换算法：对等方需要确定邻居的优先权，谁提供数据的速率快选谁
                1. 对等方A持续测量接收到比特的速率，然后确定以最高速率流入的4个邻居
                2. 然后A将数据块发送给这4个邻居
                3. 每过10s，A重新计算该速率并可能修改对等方
                4. 每过30s，A将随机选择一个另外的邻居并向它发送块
             3. 部分（小块）？？？
             4. 管道
             5. 随机优先选择
             6. 残局模型
             7. 反怠慢
          8. 解决了"免费搭车"问题（只下载不上载）
    2. 在对等方社区中组织并搜索信息（信息到主机位置的映射）
       1. 集中式索引  ![P2P 集中式索引](../img/net/net-p2p-centralized-index.png)
          1. 单点故障
          2. 性能瓶颈和基础设施费用
          3. 侵犯版权
       2. 查询洪泛 ![P2P 覆盖网络](../img/net/net-p2p-overlay-network.png)
          1. 最流行的是Gnutella协议
          2. 性能和查询精准度不可兼得
       3. 层次覆盖 ![P2P 层次覆盖网络](../img/net/net-p2p-hierarchical-overlay-design.png)
          1. 结合了上2者的有点，与因特网高速连接的对等方被指派为超级对等方，它维护者子对等方的索引。
       4. 分布式三列表（Distributed Hash Table ，DHT）
          1. 产生一个全分布式索引，该索引将文件标识映射到文件位置
          2. 郧西用户确定文件的所有位置，而不会产生过量的搜索流量
    3. Skype（一个成功的因特网电话应用）
11. TCP套接字编程
12. UDP编程
13. 端口号
    1. 16比特的数据，在0-65535之间
    2. 部分端口已被占用（HTTP-80，FTP-22等）

### 网络模型-传输层
1. 概述
   1. 运输层为运行在不同主机的应用进程提供了逻辑通信（logic communication），而非物理通信。
   2. 逻辑通信概念![逻辑通信](../img/net/net-logic-communication.png)
   3. IP协议为主机提供了逻辑通信，它的服务模型是尽力而为交付服务（base-effort delivery service）。但是它并不保证报文的交付/按顺序交付/报文的完整性。
   4. UDP和TCP的基本任务是将两个端系统的Ip的交付服务扩展为运行在两个端系统上进程之间的交互服务。
      1. 将主机间的交付扩展到进程间交付，称为运输层的多路复用（transport-layer multiplexing）与多路分解（demultiplexing）
      2. UDP和TCP还可以通过在其报文段的首部添加差错检测字段而提供完整性检查
   5. TCP提供的服务
      1. 可靠数据传输：通过流量控制、序号、确认和定时器技术，保证数据正确的、按顺序的交付
      2. 拥塞控制
   6. UDP提供的服务
      1. 数据交付
      2. 差错检测
   7. 多路复用与多路分解![多路复用](../img/net/net-multiplexing.png)
      1. 将运输层报文段的数据交付到正确的套接字称为多路分解
      2. 从源主机的不同套接字收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传输到网络层的工作称为多路复用
         1. 套接字有唯一表示标识符
         2. 每个报文段有特殊字段（包含源端口号和目标端口号）来指示该报文段所要交付的套接字。
      3. UDP套接字使用包含目的IP地址和目的端口号的二元组来标识，TCP套接字包含（源IP地址，源端口号，目的IP地址和目的端口号）；举例：
         1. 如果2个UDP报文携带同样的IP和端口号，那么将通过相同的套接字定向到相同的目的进程
2. UDP
   1. 优点
      1. 应用层能更好的控制要发送的数据和发送时间
      2. 无需连接建立（无连接状态，分组首部开销小 ，8字节相对于20字节的TCP头部）
   2. UDP报文格式![UDP报文格式](../img/net/net-udp-segent.png)
      1. 源端口号（2字节 16比特）
      2. 目标端口号（2字节 16比特）
      3. 长度（2字节 16比特）:指明了包含首部在哪的UDP报文段长度
      4. 校验和（2字节 16比特）
         1. 计算方式：发送方的UDP对报文段中的所有16比特字的和进行反码运算，求和时遇到的任何溢出都被回卷。
         2. 实现差错检测功能（不提供差错恢复，某些实现丢弃受损报文，有些则是将受损内容交给应用程序告警）
3. 可靠性传输协议 Reliable data transfer protocol![可靠性传输协议](../img/net/net-reliable-dtp.png)
   1. 协议演进
      1. 完全可靠信道上的可靠数据传输 rdt1.0 ![完全可靠信道上的可靠数据传输](../img/net/net-rdt1.0.png)
         1. 发送方（图a）和接收方（图b）都有一个有限状态机（finite-state-machine，FSM）
         2. 此处FSM只有一个状态，图中的箭头指示协议从一个状态跃迁到另一个状态（回到自身）；引起变迁的事件在横线上方，事件发生时的状态显示在横线下方；对事件没有采取动作或没有动作使用符号^表示。FSM的初始状态使用虚线表示
      2. 具有比特差错信道上的可靠数据传输：rdt2.0![具有比特差错信道上的可靠数据传输](../img/net/net-rdt2.0.png)
         1. 该协议使用了差错检测、肯定确认和否定确认
         2. 发送方有2个状态。
            1. 左边状态：发送方协议正等待来自上层的数据，放rdt_send(data)事件发生时，发送方将产生一个包含待发数据的分组（sndpkt），计算出检验和，然后经由udt_send(pkt)发送该分组
            2. 右边状态：发送方协议等待接收方的ACK或者NCK分组（等待期间不能接受上层数据，更不能发送数据，这种行为被称为停等协议）
               1. 如果收到ACK，回到等待上层数据的状态
               2. 如果NCK，该协议重传最后一个分组，并等待接收方的响应
         3. 接收方的FSM只有一个状态，分组到达时，要么响应ACK，要么响应NCK
         4. ACK或者NCK受损的情况？在数据分组中添加一个新的字段，让发送方对数据分组编号，即将发送的数据的序号放在该字段。接收方只需要检查序号即可确定收到的分组是否是重传。
      3. rdt2.1 ![rdt2.1](../img/net/net-rdt2.1.png)
      4. rdt2.2（接收方必须包括一个由ACK确认的分组序号，发送方需检测确认中的分组序号是否正确，解决丢包后怎么处理） ![rdt2.1](../img/net/net-rdt2.2.png)
         1. 校验和
         2. 序号（冗余分组功能）
         3. ACK分组
         4. 重传
      5. 具有比特差错的丢包信道上的可靠数据传输 rdt3.0 ![rdt3.0](../img/net/net-rdt3.0-ibp.png)
         1. 发送方![rdt3.1](../img/net/net-rdt3.0-sender.png)
         2. rdt3.0 也被称为比特交替协议
         3. 流水线可靠数据传输协议![rdt3.1](../img/net/net-rdt-wait-protocol.png)
            1. 停等协议的效率非常低，发送方往信道写入数据的时间比数据往返时间少好几个数量级，经常处于等待状态
            2. 流水线协议带来的影响
               1. 增加序号范围。每个分组（不包含重传）都必须有一个唯一的序号，而且允许有多个传输中未确认的分组
               2. 协议的发送方和接收方必须能缓存多个分组
               3. 所需序号的范围和对缓冲的要求取决于数据传输协议处理丢失、损坏、过度延时的方式
            3. 处理差错恢复的2中基本方法
               1. 回退N步（Go-Back-N，GBN）![GBN](../img/net/net-rdt-gbn.png)
                  1. 允许发送方发送多个分组而不需等待确认，但是流水线中未确认的分组数不能超过某个最大允许数N。因此N常被称为窗口长度，GBN也被称为滑动窗口协议
                  2. FSM模型![GBN-FSM](../img/net/net-rdt-gbn-fsm.png)
                  3. 发送方响应事件
                     1. 上层调用：当上层调用rdt_send()时，发送方首先检查发送窗口是否已满。未满则创建分组并发送，已满则将数据返回上层，或者其他方式（不同协议的实现不同）
                     2. 收到ACK：在GBN协议中，对序号为n的分组的确认采取累计确认方式，标识接收方已正确接受到序号n以前的所有分组。
                     3. 超时事件：如果出现超时，定时器将重传所有已发送但未被确认的分组
                  4. 接收方
                     1. 如果一个序号为n的分组被正确接收到，并且按序（上次交付给上层的数据是序号未n-1的分组），则接收方给分组n发送一个ACK，并将数据交付给上层。
                     2. 其他所有情况都将丢弃该分组，并为最近按序收到的分组重传ACK
               2. 选择重传 SR ![SR-index](../img/net/net-rdt-sr-index.png)
                  1. 发送方
                     1. 上层调用：同GBN
                     2. 超时：定时器用来防止丢失分组。每个分组必须有自己的逻辑定时器，因为超时后只能发一个分组
                     3. 收到ACK：如果收到ACK，且序号在窗口中，则SR发送方经那个被确认的分组标记为已接受。如果该分组序号=send_base，则窗口基序号向前移动到具有最小序号的未确认分组处。窗口移动后发送未发送的序号
                  2. 接收方
                     1. 序号在\[rcv_base,rcv_base+N-1]内的分组被正确接收，则发送ACK；
                     2. 如果是以前没收到的分组，则被缓存；
                     3. 如果该分组的序号等于接收窗口的基序号rcv_base，则该分组以及之前被缓存的序号连续的分组交付给上层，然后接收窗口向前移动；
                     4. 序号在\[rcv_base-N,rcv_base-1]内分组被接收，必须产生ACK，即该分组是之前已确认的分组；(ACK可能丢失，双方窗口不一致)
                     5. 其他情况，忽略该分组
                  3. 窗口太大的困境：如何判断是新分组，还是重传
4. TCP协议
   1. TCP连接
      1. 全双工服务：数据在进程A和B双向流通
      2. 点对点连接：是在单个发送方和单个接收方的连接（多播指在一次发送操作中，从一个放松方将数据库传送给多个接收方，TCP不支持多播）
      3. 建立连接的过程（3次握手） ：客户端先发送一个特俗的TCP报文段，服务器使用另一个特殊的报文段来响应，客户端再用第三个特殊报文响应（第三次可以承载有效载荷）
      4. 数据传送
         1. 数据一旦通过socket套接字，就由客户机运行的TCP控制。TCP将这些数据引导到该连接的发送缓存（三次握手初期设置的缓存之一）里，不时取数据去发送。
         2. TCP从缓存中取出并放入报文段的数据量受限于最大报文段长（MSS）。MSS通常根据最大链路层帧长度来设置，本地发送主机发送长度是这样的帧，即最大传输单元（MTU）。
         3. TCP将每块客户机数据加一个TCP首部，从而形成多个TCP报文段。这些报文段被下传给网络层，网络层将其分别封装在网络层IP数据报中。然后这些IP数据报被发送到网络中
         4. TCP另一端接收到一个报文段后，该报文段的数据就被放入该TCP连接的接收缓存中。
         5. TCP缓存![TCP缓存](../img/net/net-tcp-buffer.png)
      5. TCP报文段结构![TCP报文段结构](../img/net/net-tcp-segent-structer.png)
         1. 原端口号+目的端口号（32bit）：用于多路复用/多路分解来自或送至上层应用的数据
         2. 序号字段（32bit）
            1. 序号建立在传送的字节流上，而不是建立在传送的报文段的序列之上。序号是指该报文段首字节的字节流编号
            2. 假设需要传输500000字节的文件，MSS=100，那么第一个报文段的序号=0，第二个报文段的序号=1000...
         3. 确认号字段（32bit）
            1. 填写发送方期望从连接方接收到的下一字节的序号（因为TCP是全双工服务）
            2. 假设A收到B包含字节0-535，900-1000的报文段，在等待536及其之后的字节。这里将发送536。（失序的900-1000报文并没有规则怎么处理，丢弃或缓存，实际使用了后者）
            3. 因为TCP只确认数据流中至第一个丢失字节为止的字节，因此被称为累计确认
         4. 接收窗口（16bit）
         5. 首字段长度（4bit）
         6. 可选与变长的选项字段：用于发送方和接收方协商的最大报文段（MSS），活在高速网络环境下用作窗口调节因子时使用
         7. 标志字段（6bit）
            1. ACK：用于确认指示字段中的值是有效的，即该报文段包括一个对已被成功接收的报文段的确认
            2. RST、SYN、FIN用于连接建立和拆除
            3. PSH：该值被设置标识接收方应立即将数据交给上层
            4. URG：标识报文段里存在被发送方上层置为"紧急"的数据。紧急数据的最后一个字节是由16比特的紧急数据指针字段指出。
         8. 紧急数据指针（16bit）：当紧急数据存在并给出指向紧急数据尾的指针时，TCP必须通知接收方的上层实体。
         9. 互联网校验和（16bit）
         10. 备注：PSH、URG和紧急数据指针并没有使用???
   2. telnet协议
   3. 往返时延的估计与超时
      1. 往返时延估计
         1. 报文段的样本RTT（SimpleRTT）是从某报文段发出（交给IP）搭配对该报文段的确认被收到之间的时间量。
         2. 因为SimpleRTT是波动的，为了估计平均值，TCP还维护了一个平均RTT（EstimatedRTT）。每当收到一个新的SimpleRTT，会对应的更新EstimatedRTT
         3. EstimatedRTT计算公式：EstimatedRTT = EstimatedRTT(1 - a) + a * SimpleRTT ;RFC 2988定义a=0.125
         4. 随着SimpleRTT数量增多，最终趋向于平缓。a=0.125远大于1/次数，因为最新的SimpleRTT反应了最新情况，占比重较大
         5. RTT偏差DevRTT=(1-b)*DevRTT+b*|SampleRTT-EstimatedRTT|，b的推荐值为0.25
      2. 设置和管理重传时间间隔
         1. 超时时间应大于EstimatedRTT，否则会造成不必要的重传
         2. 超时时间不应超出EstimatedRTT太多，否则当报文段丢失，TCP不能很快重传报文段，传输时延较大
         3. TimeoutInterval=EstimatedRTT+4*DevRTT
   4. 可靠数据传输
      1. IP不保证数据报的交付，数据报的按序交付，也不保证数据的完整性。TCP的可靠数据传输服务保证一个进程从其接收缓存中读出非损坏的/无间隔的/非冗余的/按序数据流，与发送端发出字节流完全一样。
      2. 简单发送方![简单发送方](../img/net/net-tcp-simple-sender.png)
         1. 意外情况
            1. 确认丢失，超时后发起重传，主机丢失重复包并返回ACK。![确认丢失](../img/net/net-tcp-simple-sender-1.png)
            2. 确认超时，超时后发起重传，主机丢失重复包并返回最新ACK。![确认超时](../img/net/net-tcp-simple-sender-2.png)
            3. 确认丢失，主机返回最新ACK。![确认超时](../img/net/net-tcp-simple-sender-2.png)
         2. 加倍时间间隔。第一次发送报文的timeoutInterval根据公式计算得出，之后每次TCP重传会将下一次的超时事件设为先前值的2被。防止因为网络拥塞时持续输入，使拥塞更严重。
         3. 快速重传。当发送方接收到对相同数据的3个冗余ACK，他就认为跟在这个已被确认3次的报文段已经丢失，然后执行快速重传![确认超时](../img/net/net-tcp-fast-retransmit.png)
         4. 回退N步，还是选择重传？都没有，TCP使用选择确认：它允许TCP接收方有选择的确认失序报文段，而不是累计的确认最后一个正确接受的有序的报文段。
   5. 流量控制服务(flow-control service)
      1. 用于消除发送方使接收方缓存溢出的可能性
      2. 和拥塞控制很相似，但是针对不同原因针对的措施
      3. 过程说明：
         1. 发送方维护一个接收窗口RcvWindow=RcvBuffer-\[LastByteRcvd-LastByteRead] >= 0;当接收方RcvWindow=0，发送方仍然会发送一个字节的报文段，以获取最新的RcvWindow值，否则永远不会更新
   6. TCP连接管理
      1. 客户端TCP向服务端发送一个特殊的TCP报文段，它不包含应用层数据，首部SYN标志位被置为1。另外，客户机会选择一个起始序号（client_isn，随机化，避免某些安全攻击），并放在SYN报文的序号字段。通过IP发送给服务器
      2. 服务器收到数据后，为该TCP连接分配TCP缓存和变量，并向客户机TCP发送允许连接的报文段。报文段不包含应用层数据，包含3个重要的首部字段
         1. SYN置为1
         2. 确认号字段=client_isn+1
         3. 初始化服务器序号(server_isn)并放入TCP报文段首部的序号字段
      3. 客户端收到SYNACK报文段后，为该连接分配缓存和变量。并向服务器发送一个报文段
         1. SYN置为0
         2. 确认号字段=server_isn+1
      4. 连接建立完成，之后每个报文的SYN都等于0
      5. 客户端发送FIN=1
      6. 服务端回复ACK
      7. 服务端回复FIN
      8. 客户端回复ACK，连接断开
      9. 图例![TCP连接图例](../img/net/net-tcp-connect-example.png)
   7. 拥塞控制服务
      1. 原因
         1. 分组速率接近链路容量时，分组经历的巨大排队时延
         2. 发送方必须执行重传以补偿以补偿因为缓存溢出而丢失的分组
         3. 当一个分组沿一条路径被丢弃时，每个上游路由器用于转发该分组而使用的传输容量最终被浪费掉了
      2. 方法
         1. 端到端拥塞控制
         2. 网络辅助的拥塞控制
      3. ATM ABR拥塞控制（属于网络辅助的拥塞控制）：
         1. ATM采用面向虚电路（VC）的方法来处理分组交换。
         2. 源到目的地的路径每条交换机都维护着源到目的地VC的状态，可以根据状态跟踪发送方的行为，并采取特定的拥塞控制动作。
         3. ATM ABR拥塞控制基于速率，即发送方明确的计算出他能发送的最大速率，并据此对自己进行相应的调整。交换机向接收方通知交换机拥塞的机制：
            1. EFCI比特。每个数据信元都包含1比特的显示转发拥塞指示。一个拥塞的网络交换机可把数据信元中的EFCI比特设置为1，来向目的主机发出拥塞的信令。目的检测到达的RM信元，如果多数信元的EFCI被置为1，目的地将RM的EFCI设为1，并将该RM发送给发送方，通知网络拥塞
            2. CI和NI比特。RM信元和数字信元的比例可调，默认是1:32。RM信元有一个CI比特和NI比特，NI比特置为1标识轻微拥塞，CI比特标识严重拥塞
            3. 每个RM信元还包含1个2字节的ER字段。一个拥塞的交换机可能降低经过的RM信元中ER的值，ER字段将被设置源至目的地路径上所有交换机中的最小支持比率
   8. TCP拥塞控制
      1. TCP必须使用端到端拥塞控制机制，因为IP层不向端系统提供显示的网络拥塞反馈？？？
      2. TCP发送方通过感知网络拥塞的程度，来调节发送流量的速率。
         1. 发送方如何限制发送速率？
         2. 发送方如何感知网络拥塞？
         3. 采用什么算法来改变发送速率？
      3. 发送速率计算，TCP让每一段记录一个额外变量，即拥塞窗口（congestion window，congWin），LastByteSent-LastByteAcked <= min{congWIn,RcvWindow}
      4. TCP拥塞控制算法
         1. 加性增，乘性减（AIMD）
            1. 当出现丢包事件，通过减小congWin降低发送速率。每发生一次丢包，congWin减半，最低不小于一个MSS。
            2. 如果没有检测到拥塞，则可能有可用带宽，TCP会缓慢增加CongWin长度。实际上，TCP发送方每收到一个确认后酒啊CongWin增大一点，其目标是在每个往返时延的congWin增加一个MSS。
            3. ![速率与时间图](../img/net/net-tcp-cong-aimd.png)
         2. 慢启动（Slow Start，SS）
            1. TCP连接开始时，congWin的长度只有一个MSS。但如果带宽很大，需要很久的时间才能达到最大速度。
            2. 因此RTT已指数的形式递增，每过一个RTT，congWin翻倍，直到发生一个丢包事件为止。
            3.  ![SS示意图](../img/net/net-tcp-cong-ss.png)
         3. 对超时事件做出反应
            1. 如果TCP收到3个冗余ACK，当作普通丢包事件处理，congWin减为一半。
            2. 如果收到超时事件，TCP发送方进入一个满启动阶段。指数增长，丢包，congWin减为一半...（在Tahoe算法中，3个冗余ACK也会进入慢启动，Reno不会，后者被称为快速恢复）
            3. TCP通过维持一个阈值来管理这个动态过程，它用来确定慢启动将结束并且拥塞避免将要开始的长度。Threshold初识时被设置为一个很大的值，每发生一次丢包，threshold=congWin/2。
            4. ![示意图](../img/net/net-tcp-cong-timeout.png)
         4. 对TCP吞吐量的宏观描述假设congWin=2，发送速率在线性增长和减半中，则平均吞吐量=(0.75*w)/RTT
   9. 某些版本的TCP协议使用了隐式NAK机制
5. 常用协议使用的传输层协议![常用协议使用的传输层协议](../img/net/net-base-transfer-protocol.png)
6. 其他协议：
   1. 数据报拥塞控制协议：Datagram Congestion Control Protocol，DCCP
      1. 它提供了低开销/面向报文/类UDP的不可靠服务，但是具有应用程序选择形式的拥塞控制。这种形式与TCP兼容
      2. 如果某应用程序需要可靠或者半可靠的数据传送，则将在应用程序中执行
   2. 流传输控制协议：Stream Control Transmission Protocol，SCTP
      1. 可靠的、面向报文的协议，运距将几个不同的应用层次的'流'多路复用到单个SCTP连接上
      2. 协议对该连接中的不同流分别进行处理，一个流的分组丢失不影响其他流数据的交付
      3. 当一台主机与2个或更多个网络连接时，SCTP也允许数据经2条出去的路径传输、失序数据可选的交付
      4. SCTP的流控制和拥塞控制算法基本上与TCP相同
   3. TCP友好速率控制：TCP-Friendly Rate Control，TFRC
      1. 是一种拥塞控制协议，而非运输层协议
      2. 这种机制可以用于注入DCCP等另一种运输层协议，它的目的是使TCP拥塞控制的"锯齿"更加平滑，同时维护一种长期的发送速率
      3. 通过检测到的丢包率计算TCP的吞吐量，从而计算TFRC的目标发送速率



### 网络模型-网络层
1. 概述
   1. 重要功能
      1. 转发：当一个分组到达某路由器的一条输入链路时，该路由器必须将分组移动到合适的输出链路。
         1. 每台路由器具有一张转发表。它检查到达分组首部的一个字段的值，使用该值在转发表中索引查询来转发一个分组。查询转发表的结果时分组被转发的路由器的链路接口。
         2. 分组首部值可能是目的地址，或分组所属连接的指示，取决于网络层协议
         3. ![简单示例图](../img/net/net-router-simple-forward.png)
      2. 选路：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为选路算法。
      3. 连接建立：
   2. 约定术语
      1. 分组交换机：它根据分组首部字段的值，从输入链路接口到输出链路接口传送分组。分为链路层交换机和路由器
      2. 链路层交换机：基于家链路层字段中的值做转发决定
      3. 路由器：根据网络层字段的值做转发决定
   3. 网络服务模型
      1. 定义:网络的一侧边缘到另一侧边缘之间分组的端到端运输特性
      2. 网络层提供服务（部分，3-6能给源和目的之间提供分组的流？？？）
         1. 确保交付，该服务确保分组将最终到达其目的地
         2. 具有时延上界的确保交付，该服务不仅确保分组的交付，而且在特定的主机到主机时延上界内（如100ms内）交付
         3. 有序分组交付，保证分组以他们被发送的顺序到达目的地
         4. 确保最小带宽，只要发送主机以低于特定比特率的速率传输比特，分组就不会丢失，且每个分组会在预定的主机到主机时延内到达
         5. 确保最大时延抖动。该服务确保发送的2个两个相继分组之间的时间量等于在目的地接收到他们之间的时间量，或这种间隔的变化不超过某些特定的值
         6. 安全性服务。使用仅仅源和目的主机知晓的秘密绘画钥匙，源主机中的网络层能加密向目的主机发送的所有数据报负载，目的主机的网络层则负责解密。除了保证机密性，还能校验数据完整性/鉴别源
   4. ATM网络体系架构
      1. 恒定比特率ATM网络服务
      2. 可用比特率ATM网络服务
2. 虚电路和数据报网络
   1. 运输层提供的面向连接/无连接服务，与网络层提供的面向连接/无连接的差别
      1. 在网络层，这些服务是网络层提供给运输层。在运输层，这些服务则是运营层向应用层层提供的进程到进程的服务。
      2. 在目前所有主要的计算机网络体系结构（因特网，ATM，帧中继）中，网络层或者提供了主机到主机的无连接服务，或者提供了主机到主机的连接服务，而不同时提供2中。
         1. 仅在网络层提供连接服务的计算机网络被称为虚电路（Virtual-Circuit，VC）网络
         2. 仅在网络层提供无连接服务的计算机网络被称为数据报网络（datagram network）
      3. 在运输层实现面向连接的服务和在网络层实现不同。运输层面向连接服务是在位于网络边缘的端系统实现，网络层连接服务除了在端系统，也在位于网络核心的路由器中实现
   2. 虚电路 VC
      1. 组成：
         1. 源和目的主机之间的路径（一系列链路和路由器）
         2. VC号，沿着该路径的每段链路一个号码
         3. 沿着该路径的每台路由器中的转发表表项。
            1. 属于一条虚电路的分组将在它的首部携带一个VC号
            2. 因为一条虚电路在每条链路上可能具有不同的VC号，所以每台路由器必须用一个新的VC号替代每个传输分组的VC号。该新的VC号从转发表获得
      2. 阶段
         1. 虚电路建立：发送方运输层和网络层联系，指定接收方地址，等待该网络建立虚电路。网络层决定发送方和接收方的路径，即该虚电路的所有分组要通过的一系列链路和路由器。网络层为该路径的每条链路确定一个VC号。最后，网络层在沿着路径的每条路由器的转发表增加一项。除此，网络层还可以预留虚电路路径上的资源，如带宽。
         2. 数据传送：![VC数据传送示例图](../img/net/net-internet-vc-transfer.png)
         3. 虚电路拆除：发送方（或接收方）通知网络层终止虚电路时，网络层将通知网络另一侧端系统结束呼叫，并更新路径上每台路由器中的转发表以表明该虚电路已不存在了。
      3. 和运输层建立连接的区别
         1. 运输层连接建立仅涉及2个端系统，2个端系统独自决定运输层连接的参数，但是网络层的路由器毫不知情
         2. 虚电路网络层连接建立，沿2个端系统路径上路由器都要参与虚电路的建立，且每台路由器都完全知道经过它的所有虚电路
      4. 端系统向网络发送指示虚电路启动与终止的报文，已经路由器之间用于建立虚电路（即修改路由器中表的连接状态）的报文被称为信令报文（signaling message）
      5. 用来交换信令报文的协议被称为信令协议（signaling protocol）
   3. 数据报网络
      1. 数据传送
         1. 步骤
            1. 发送方传送层将分组发送给网络层
            2. 网络层为分组加上目的地端系统的地址，然后将该分组推进网络中（无需建立虚电路，路由器也不维护任何有关虚电路的状态信息）
            3. 路由器根据该分组的目的地址来转发分组。（路由器有一个将目的地址映射到链路端口的转发表；当分组到达路由器时，该路由器根据目的地址在转发表中查找适当的输出链路端口，然后将该分组向该输出链路接口转发）。
         2. 示意图![数据报网络数据传送示例图](../img/net/net-internet-datagram-transfer.png)
         3. 和VC对比
            1. VC的建立和拆除，都立即更新路由器，延迟时间在微秒级；数据网网络的转发表是由选路算法修改的，通常1-5分钟更新一次。
            2. 数据报网络的转发表能在任何时刻修改，所以在2个端系统之间发送的一系列分组可能通过不同的路径，并可能无序到达。
   4. 数据报网络和虚电路的由来
      1. 虚电路来源于电话界，采用了真正的电路。
      2. 因特网由互联计算机的需求发展而来。由于端系统设备复杂得多，因特网设计者选择时网络层服务模型尽可能简单。特性：
         1. 提供最少服务保证的因特网模型，是的互联使用不同的链路层技术（卫星、以太网、光纤、无限）的网络变得更加容易，而且具备不同的传输速率和丢包特性。
         2. web饮用，DNS服务等都是在位于网络边缘的主机（服务器）实现的，增加一项新服务能力只需要将一台主机介入到网络中，并订一个新的应用层协议即可，这是的web之类的新服务可以很快的在因特网得到应用。
3. 路由器工作原理
   1. 结构
      1. 示意图![路由器结构示例图](../img/net/net-internet-router-structer.png)
      2. 输入端口
         1. 将一条输入的物理链路接到路由器的物理层链路
         2. 执行需要与位于入链路远端的数据链路层功能交互的数据链路层功能
         3. 查找与转发，使转发到路由器交换结构的分组能出现在对应的输出端口
         4. 控制分组从输入端口转发到选路处理器
      3. 交换结构：将路由器的输入端口连接到它的输出端口。交换结构完全包容在路由器中，相当于网络路由器中的网络
      4. 输出端口：存储经过交换端口转发给它的分组，并将这些分组传输到输出链路。输出端口执行与输入端口顺序相反的数据链路层和物理层功能。当一条链路是双向链路时，输出端口和输入端口在线路卡上成对出现。
      5. 选路处理器：执行选路协议，维护选路信息和转发表，并执行路由器中的网络管理功能
   2. 输入端口
      1. ![路由器输入处理示例图](../img/net/net-internet-router-input.png)
      2. 每个输入端口都拷贝了一份转发表（会被更新），直接做出转发决定，无需调用中央选路处理器，可避免单点瓶颈。
      3. 如果输入端口处理能力受限，依然会将分组转发给中央选路处理器处理。处理速率期望达到线路速度（line speed，即一次查找时间应少于输入端口接收分尊的时间），约百万次每秒
      4. 查找算法：
         1. 内容可寻址内存（Content Addressable Memory，CAM）：允许将一个32比特的ip地址提交给CAM，由它再以基本上常熟时间返回改地址对应的转发表表项内容。
         2. 高速缓存 Feldmeier 1988
         3. 新数据结构 Waldvogel 1997
         4. 压缩转发表 Brodnik 1997
         5. ...
      5. 多个输入端口同时向交换结构传输分组时，可能会因为并发阻塞，导致排队和调度
   3. 交换结构
      1. ![路由器交换结构示例图](../img/net/net-internet-router-exchange.png)
      2. 交换结构位于路由器的核心部位，通过它才能实际的从输入端口转发到一个输出端口中。上图有3中交换技术
         1. 经内存交换
         2. 经一根总线交换：输入端口经共享总线将分组直接传送到输出端口，不需要选路交换器的干涉。但由于总线共享，一个只能有一个分组通过总线传送，路由器交换带宽首总线速率的限制。
         3. 经一个互联网络交换：使用2n条总线组成的计算机互联网路将n个输入/输出端口连接。一个新到达的分组沿水平总线穿行，在交叉点判断输出端口是否空闲，而从传输或阻塞。
   4. 输出端口
      1. ![路由器输出处理示例图](../img/net/net-internet-router-output.png)
   5. 排队
      1. RFC 3439规定，路由器缓存量B=RTT*C（链路容量）
      2. Appendzeller 2004提出新的计算公司B=RTT*C/n，n平方=N（TCP流）。说明N越大，所需的缓存长度将明显减小
      3. 因为可能的输出阻塞，输出端口的分组调度程序必须从这些排队的分组选一个进行传送。选择策略有：
         1. 时间顺序FCFS调度
         2. 加权公平排队WFQ调度
      4. 如果没有足够的缓存保存分组，那么必须丢弃新到达的分组，或者删除正在排队的分组，这些策略被称为主动队列管理算法（Active Queue Management，AQM）算法
      5. 随机早期检测（Random Early Detection，RED）算法属于一种最广泛的AQM算法
         1. 为输出队列长度维护一个加权平均值avg
         2. 如果平均值小于最小阈值min，新分组直接纳入队列；若avg>max，该分组被丢弃；若min<avg<max，该分组以某种概率被标记或丢弃
      6. 线路前部（Head-Of-thd-Line ,HOL)阻塞:输入队列的第一个元素被阻塞，导致后续的元素不能被转发给输出端口。McKeown 1997b讨论了许多解决HOL阻塞的方法。
4. 网际协议：因特网的转发和编址
   1. 组件
      1. 示意图![网络层示意图](../img/net/net-internet-layer.png)
      2. IP协议
      3. 选路组件
      4. 报告数据报中差错和对某些网络层信息请求进行响应的设施
   2. 数据报格式
      1. 示意图![IPv4数据报示意图](../img/net/net-internet-ipv4-datagram.png)
      2. 4比特版本号：路由器可根据版本号确定如何解释IP数据报的剩余部分，不同版本号使用不同的数据报格式
      3. 4比特首部长度：IPv4数据报可包含一些可选项，首部长度用来确定IP数据报中的数据部分实际从哪里开始。大多数IP数据版不包含可选项，几乎都有20字节的首部
      4. 8比特服务类型：服务类型TOS用来区分不同类型的IP数据报
      5. 16比特数据报长度：这是IP数据报的总长度（首部+数据），以字节计，所以IP数据报的理论最大长度为65535字节。实际应用中，数据报很少超过1500字节
      6. 16比特标识：
      7. 3比特标志：
      8. 13比特片偏移：
      9. 8比特寿命：（Time-To-Live，TTL）字段用来确保数据报不会永远在网络中循环。每当数据报经过一台路由器时，该字段值减1。若TTL=0，该数据报会被丢弃
      10. 8比特协议：该字段仅在一个IP数据报到达最终目的地才会用到，用于指明IP数据报的数据部分应交给那个运输层协议。6表明数据交给TCP，17表明交给UDP，其他详见RFC1700，RFC3232
      11. 16比特首部校验和：用于帮助路由器检测收到的IP数据报中的比特错误。计算过程如下：
          1. 将首部中的每2个字节当作一个树，用反码运算对这些数求和
          2. 将和与数据报首部携带的校验和比较。
             1. 如果检测出错，丢弃该数据报
             2. 如果检测正确，路由器重新计算校验和并保存在原处。因为TTL会变化，所以需重新计算。
          3. IP只校验首部，TCP/UDP对整个报文段进行校验
      12. 32比特源IP地址
      13. 32比特目的IP地址
      14. 选项：选项字段允许IP首部被扩展，实际上很少使用，实现也比较复杂，不使用该字段可能节约开销。在IPv6协议不再使用
      15. 数据（有效载荷）：发送给运输层的报文段。TCP/IP数据报=IP首部+TCP首部+应用层报文=20字节+20字节+应用层报文
   3. IP数据报分片
      1. 并不是所有的链路层协议都能承载相同长度的网络层分组，如以太网帧可承载不超过1500字节的数据，某些广域网链路的帧可承载不超过576字节的数据，一个链路层能承载的最大数据量叫做最大传输单元。
      2. 数据转发路径会经历多个不同的链路，每个链路使用不同的链路层协议，每种协议可能具有不能的MTU。
      3. 假设数据由发送方发放第一个路由器时，MTU=1500；由第一个路由器发往第二个路由器时，MTU=576。此时，数据报会被分成更小的数据报，再经过链路层封装这些较小的数据报，然后向输出链路上发送这些帧。这些较小的数据叫做片。
      4. 片在达到目的地的运输层以前需要被重新组装，但是IPv4的设计者认为在路由器完成组装会影响路由器性能，最终组装工作在端系统完成
      5. 目的主机如何组装分片？这需要用到IP报文中标识，标志和片偏移了。
         1. 创建数据报时，发送主机给数据报设置源和目的地址的同时，设置标识号为1（不一定是1，每个IP报的标识是一样的）
         2. 路由器将数据报分片时，每个片都附加上源地址、目标地址和标识号，最后一个片的标志设为0，其他片标志设为1。
         3. 为了让目的主机确认一个片是否丢失（且按照正确的顺序重新组装片），偏移字段指定片应放在出事IP数据报的哪个位置。偏移值被规定为8字节块为单位，假设偏移为1600字节，偏移值=1600/8=200
      6. 示意图![IPv4数据报分片组装示意图](../img/net/net-internet-ipv4-datagram-sharding.png)
      7. IP分片逻辑复杂，并可能导致攻击。在IPv6废止了分片。
   4. IPv4编址
      1. 主机通常只有一条链路连接到网络。当主机中的IP想发送一个数据报时，他就在该链路上发送，主机与物理链路之间的边界叫做接口
      2. 路由器与它任意一条链路的边界也叫接口
      3. IP地址在技术上时与接口相关联的，而不是包含接口的主机或路由器。 问题：难道一个路由器可以对应多个IP？？
      4. IP地址使用点分十进制记法，么个字节以十进制书写，各字节用句点隔开。
      5. 子网![IPv4子网示意图](../img/net/net-internet-ipv4-subnet.png)
         1. 示意图中，1台路由器，3个接口，互联7台主机。
         2. 左上3台主机以及连接路由器的端口的IP地址格式为223.1.1.***,左侧的24比特是相同的，这4个接口也通过一个不包含路由器的网络互联起来。
         3. IP的术语中，互联这3台主机的接口与路由器一个接口的网络形成一个子网。
         4. IP编址为这个子网分配一个地址223.1.1.0/24。/24有时称为子网掩码，表明32比特中左侧24比特定义了子网地址。任何连接到223.1.1.0/24的主机都要求其格式为223.1.1.***。
         5. 一个子网的IP定义并不局限于连接多台主机到一台路由器接口的以太网段。一般定义：分开主机和路由器的每个接口，从而产生了几个分离的网络导，接口断接了这些独立的网络的端点，这些独立的网络中的每个都叫做一个子网。
         6. 如下图中，3台路由器连接了6个子网![IPv4子网示例](../img/net/net-internet-ipv4-subnet-sample.png)
      6. 因特网的地址分配策略被称为无类别域间选路（Classless Interdomain Routing,CIDR)，它对于子网寻址，32比特被划分为2部分并且也具有点分十进制形式a.b.c.d/x,x指示了在地址的第一部分中的比特数
      7. 形式a.b.c.d/x的地址的x最高比特构成了IP地址的网络部分，经常被称为改地址的前缀。一个组织经常被分配一块连续的地址，即具有相同前缀的一段地址，路由匹配时大大减少了路由器转发表的长度
      8. IP地址聚合![IPv4地址聚合](../img/net/net-internet-ipv4-address-aggregation.png)
      9. 32-x比特用于区分组织内部设备，只有组织内部的路由器转发分组时，才会考虑到这些。
      10. 在采用CIDR之前，IP地址的网络部分被限制为长度为8，16，24比特子网地址的网络被称为A、B、C类网络，这种编址方案被称为分类编址（classful addressing）
      11. 当主机向IP广播地址255.255.255.255发送数据报时，该报文会被交付给同一个子网中的所有主机
      12. 一个组织如何获得IP地址的？
          1. 网络管理员联系对应的ISP，ISP会从自己管理的地址提供一些地址
          2. 网络管理员可以配置路由器中的IP地址，或者配置主机。但通常由动态主机配置协议DHCP来完成
   5. 动态主机配置协议DHCP
      1. 是一种客户机/服务器协议
      2. 可以配置主机连接网络时使用相同的IP地址，也可以分配一个临时的IP地址（维护可用IP地址表，动态分配和回收）
      3. 除了为主机分配，DHCP还允许主机获取子网掩码、默认网关和它的本地DNS服务器的地址
      4. 因具有将主机连接进一个网络的自动化网络相关的能力，故而又称为即插即用协议（plug-and-play protocol）
      5. 4个步骤
         1. DHCP服务器发现：客户机生成包含DHCP发现报文的IP数据报，该报文使用广播目的地址255.255.255.255并且使用本主机0.0.0.0。链路层将该帧广播到所有与该子网连接的子网
         2. DHCP服务器提供：服务器收到DHCP服务器后，用一个DHCP提供报文对客户机做出响应，仍然使用IP广播地址255.255.255.255。因为一个子网可能包含多个DHCP服务器，客户机需选择1个。
         3. DHCP请求：客户机选择DHCP服务器后，用一个DHCP请求报文进行响应，回显配置参数
         4. DHCP ACK：服务器使用DHCP ACK报文对DHCP报文进行响应，证实所要求的参数。交互完成
         5. 备注1：服务器提供报文包含报文的事务ID、向客户机推荐的IP地址、网络掩码、IP地址租用期（通常为几小时或几天），且允许客户机更新租用期。
         6. 备注2：每一步使用了一类报文，发现报文、提供报文、请求报文、ACK报文
      6. 网络地址转换（NAT）
         1. 工作原理：子网的IP地址在整个Internet网络毫无意义。客户机发出的报文会被NAT-DHCP拦截，修改IP为路由器IP、端口为未使用端口。响应报文同样会被NAT拦截掉，路由器IP改为内网IP，端口修改为客户机原端口
         2. 例子：路由器IP为2.213.210.3、端口0-2000被占用，客户机IP为192.168.0.3
            1. 客户机使用端口5023向服务器2.213.210.4:80发送web请求时，NAT将源IP地址修改为2.213.210.3，源端口修改为2001，并维护2001-192.168.0.3:5023的映射关系
            2. 当NAT 的2001端口收到数据时，通过映射关系找到192.168.0.3的主机，TCP协议将对应数据给5023端口
      7. UPnP
         1. 定义：是一种允许主机发现并配置临近NAT的协议。
         2. 功能：在一台主机上运行的应用层虚能够为某些请求的公共端口号请求一个NAT映射。如果NAT接收该请求并生成映射，则外部节点能发起TCP连接。
   6. ICMP：互联网控制报文协议
      1. 介绍：定义于RFC792，用于主机和路由器彼此交互网络层信息，最典型的用途是差错报告。
      2. ICMP承载在IP分组中，作为IP的有效载荷承载
      3. 报文：一个类型字段、一个编码字段，并且包含引起该ICMP报文首次生成的IP数据报的首部和前8字节内容
      4. ICMP的类型![ICMP的类型](../img/net/net-internet-ICMP-type.png)
   7. IPv6
      1. 数据报格式![IPv6数据报](../img/net/net-internet-ipv6-datagram.png)
         1. 版本号：4比特。值为6，但是不兼容将4
         2. 流量类型：8比特。和IPv4的TOS字段类似
         3. 流标签：20比特。用于表示一个数据报的流
         4. 有效载荷长度：16比特。无符号整数，给出IPv6数据报跟在定长的40字节数据报首部后面的字节数量
         5. 下一个首部：8比特。标识将数据报的内容交付给哪个协议，同IPv4
         6. 跳限制：8比特。类似IPv4的TTL字段，每台经过的路由器对该字段减1，该值为0的数据报将被丢弃。
         7. 原地址：128比特。格式详见RFC4291
         8. 目的地址：128比特。格式详见RFC4291
         9. 数据：
      2. 报文相对IPv4的变化
         1. 分片/重新组装：IPv6不允许中间路由器进行分片和组装，只能在源和目的地执行。路由器遇到太大的数据报可丢弃并向发送方返回"分组太大"的ICMP差错报文即可，发送分将使用较小长度的IP数据报重发数据
         2. 去掉了校验和。IPv4的TTL变更后，需要重新计算，也会比较耗时。即时网络层去掉了，而运输层和数据链路层也执行了校验操作。
         3. 选项：可选，可能在下一个首部字段指出
      3. 相对于IPv4的变化
         1. 地址扩充到了128比特。除了单播和多播，还引入了任播地址，它可以使数据报能交付给一组主机的任意一个。
         2. 简单高效的40字节（字节，不是比特？）首部
         3. 流标签和优先级：指明某些应用的数据报比其他应用的数据报有更高的优先权（流量分vip？？）
      4. 版本迁移
         1. 指定时间，停止服务
         2. 双栈：节点同时兼容IPv4和IPv6
         3. 建隧道：可以将IPv6的数据放到IPv4的有效载荷，后面再组装
   8. IP安全性
      1. IPsec被设计为与IPv4和IPv6向后兼容
      2. 面向连接的，只需要在2台主机中可用，不影响经过的路由器
5. 选路算法（理论）
   1. 路径：一台主机通常与一台路由器相连，路径是指源路由器到目标路由器的路线
   2. 选路算法使用图描述，路由器为节点，链路为边，边的权重则是链路消耗的费用，算法目的则是求最小路径。
   3. 分类
      1. 根据该算法是全局性还是分布式来区分
         1. 全局算路算法：必须在算法开始计算之前，就明确所有节点的连通性和所有费用的输入，因此又称为链路状态算法（LS）
         2. 分布式选路算法：以迭代的，分布式的方式计算出最短路径。也称为距离向量算法
      2. 根据算法是静态还是动态来区分
         1. 静态选路算法：随着时间推移，路由变化非常缓慢，通常是人工进行调整
         2. 动态选路算法：能够在网络流量负载或拓扑变化时改变选路路径。一个动态算法可周期性的运行，或直接的形影拓扑或链路费用分变化而运行。但是容易收到选路循环、路由振荡等问题的影响
      3. 根据是负载敏感还是负载迟钝分类
         1. 负载敏感算法：链路费用会动态的反映出底层链路的当前拥塞水平
         2. 负载尺寸的算法：目前的因特网选路算法都是负载迟钝的，如RIP、OSPF、BGP
   4. 全局算路算法（链路状态算法LS）
      1. 计算过程
         1. 假设源节点为u，一共有N颗节点。u与节点v、x、w距离为2、1、5，与节点y、z不直接相连
         2. 初始化：uv=2,uw=5,ux=1;不直接与u相邻的节点y、z值为无穷大；
         3. 第二轮：此时ux最小，将x节点添加到集合，更新其他节点路径为较小值
         4. 重复循环，直到第N轮
         5. ![链路状态算法](../img/net/net-internet-ipv6-datagram.png)
      2. 问题
         1. 时间复杂度为N平方，（一种优化实现采用堆结构在对数时间而不是线性时间）
         2. 链路不是堆成的，u->v和v->u的值未必相等，可能会引起路由振荡。![路由振荡](../img/net/net-internet-routing-cycle.png)
   5. 分布式选路算法(距离向量算法DV)
      1. 计算过程
         1. 假设源节点为x，目标节点为y，x的下一个节点为w，则D(x,y)=min{C(x,v)+D(v,v)};min指遍历u的邻居；假设所有节点N个
         2. 每个节点x以D(x,y)开始，对N中所有节点估计从它自己到节点y的最低费用路径的费用。每个节点维护一定的选路数据
            1. 对于每个邻居v，从x到直接相邻邻居v的费用为C(x,y);
            2. 节点x的距离向量，Dx数组包含了x到N所有目的地费用的估计值
            3. 节点x对每个邻居的距离向量Dv数组
         3. 该算法中，每个节点不时地向它的每个另据发送它的的距离向量拷贝Dx
         4. 当节点x从它的任何一个邻居v接收到一个新距离向量时，它更新Dv，并更新Dx数组的每个值。如果Dx发生了更新，则会将Dx推送给邻居向量
         5. 图例![DV算法](../img/net/net-internet-routing-DV.png)
         6. 可能会产生选路循环
   6. 电路交换选路算法（来源于电话界）
   7. 自治系统（Autonomous Systeom，AS）
      1. 解决问题
         1. 因特网由数亿台主机组成，存储选路信息需要巨大容量的内存，而且距离向量算法的迭代次数也会无限复杂
         2. 某些组织应当能按照自己的意愿运行和管理网络
      2. 每个AS由一组通常在相同管理控制的路由器组成，在相同的AS内的路由器使用相同的选路算法（自治系统内部选路协议），且拥有彼此之间的信息。AS内有一台或者多台路由器负责AS之外的目的地转发分组，被称为网关路由器。
6. 选路算法（实际应用）
   1. 因特网中自治系统内部选路：RIP
      1. RIP是一种距离向量协议
      2. RIP1在RFC1058定义，它以条数作废费用测度，每条链路费用为1。跳是指沿着源路由器到目的子网的最短路径所经过的子网数量
      3. 一条路径的最大费用被限制为15，所以RIP也只能网络直径不超过15第二次自治系统内使用
      4. RIP使用特定RIP响应报文交换选路信息，约30s交换一次。由一台路由器或主机发出的响应报文包含了一个由多达25个AS内的目的子网列表，还有发送到其中每个子网的距离。响应报文又被称为RIP通告
      5. 每台路由器维护一张选路表的RIP表，第一列为目的子网，第二列为沿着目的网络的最短路径上的下一台路由器的标识，第三列指出了沿着最短路径达到目的子网的跳数，如图![RIP表](../img/net/net-internet-routing-RIP-table.png)
      6. 如果一台路由器超过180s没有监听到邻居，则认为邻居不可达。这时候，有2中处理方式
         1. RIP修改本地选路表，然后通过向相邻的其他路由器发送通告传播该信息
         2. 路由器在UDP上使用端口520发送请求（响应）报文，请求其邻居到目的地的费用。看起来，RIP是运行在UDP上的应用层协议![RIP UDP实现](../img/net/net-internet-routing-RIP-UDP.png)
   2. 因特网中AS内部选择：OSRF
      1. 核心：一个使用洪泛链路状态信息的链路状态协议和一个Dijkstra最低费用路径算法。
      2. OSRF中的每一台路由器构建了一幅关于整个自治系统的完整拓扑图，然后运行Dijkstra算法以确定一个以自身为跟节点的到所有子网的最短路径树。各条链路费用是管理员配置的
      3. OSRF中，路由器向AS内所有路由器广播选路信息，更新时广播，或者广播时间达30min。
      4. OSRF报文承载在IP分组中，协议值为89。
      5. OSRF必须自己实现可靠报文传输、链路状态广播功能，还需检查链路正在进行，并允许OSRF路由器获得相邻路由器的网络范围链路状态的数据库
      6. 优点：
         1. 安全：OSRF可采用明文口令或MD5散列用于鉴别
         2. 多条相同费用的路径：当到达目的地的多条路径具有相同费用时，OSRF允许使用多条路径，而无须选择单一的路径来承载所有的流量
         3. 对单播选路与多播选路的综合支持
         4. 支持在单个选路域内的层次结构：一个OSRF自治系统可以配置多个区域。每个区域都运行自己的OSRF算法，一个区域的路由器都向本区域的其他路由器广播链路状态。每个区域的内部细节对于区域外路由器都是不可见的
      7. 结构
         1. 示意图 ![OSRF示意图](../img/net/net-internet-routing-OSRF.png)
         2. 内部路由器：这些路由器位于非主干区域，且只执行AS内部选路
         3. 区域边界路由器：这些路由同时属于区域的主干2个区域
         4. 主干路由器：执行主干中的选路，非区域边界路由器，非边界路由器。内部路由器通过主干路由器，从信息广播中知道存在通向其他区域的路由
         5. 边界路由器：实现AS与其他自治系统的路由器交换信息
   3. 自治系统间的选路：BGP
      1. 版本4是当今因特网中域间选路协议事实上的标准，因此又被称为BGP4
      2. 提供给AS的功能
         1. 从相邻AS处获得子网可达性信息
         2. 向该AS内部的所有路由器传播可达性信息
         3. 给予可达性信息和AS策略，决定到达子网的'好'路由
      3. BGP基础
         1. BGP是因特网绝对重要的协议，将所有东西黏合
         2. 路由器使用179端口半永久TCP连接交换选路信息。对于每条直接连接位于2个不同的AS中的路由器链路而言，通常会有这样的TCP连接，如下图的3a-1c
         3. AS内部的路由器之间还有许多TCP半连接，连接两端的路由器称为BGP对等方，通过该连接发送的BGP报文称为BGP会话。跨越两个AS的BGP会话被称为外部BGP（eBGP），AS内部的BGP会话称为内部BGP会话（iBGP）
         4. 在BGP中，目的地不是主机，而是CDIR的前缀，每个前缀标识一个子网或子网的集合
         5. 示意图![BGP示意图](../img/net/net-internet-routing-BGP.png)
      4. 路径属性和BGP路由
         1. 在BGP中，一个字系统又一个全局唯一的自治系统号ASN（有一种桩AS没有ASN，它仅仅承载原地址或目的地址为本AS的流量），又ICAN地区注册机构分配
         2. 当一台路由通过BGP会话通告一个前缀时，前缀会附带一些BGP属性。或者说，带有属性的前缀被称为一条路由。其中有2个比较重要的路由：
            1. AS-PATH：该属性包含了前缀的通告已经通过的AS。当一个前缀传到一个AS时，该AS将它的ASN添加到AS-PATH属性中。当路由器发现它的前缀包含在该属性中，将拒绝通告。
            2. NEXT-HOP：是一个开始某AS-PATH的路由器接口。？？？
         3. 当一台网关路由器接收到一个路由器通告时，它使用输入策略来决定是否接受或过滤路由
      5. BGP路由选择：可能存在多条路由达到同一个前缀，路由器会做出筛选直到剩下一条路由
         1. 路由被指派一个本地偏好值作为他们的属性之一，具有最高本地偏好值的路由将被选择。策略由网络管理员设定
         2. 在余下的路由，选择具有最小AS-PATH的路由。如果该规则是路由选择的唯一规则，则BGP算法使用DV决定路径，其中距离测试使用AS跳数而不是路由器的跳数
         3. 在余下的路由中，将选择最靠近NEXT-HOP路由器的路由。最靠近是指费用最低，由AS内部算法决定，该进程被称为热土豆选路
         4. 使用BGP标识符选择路由，参见Strwart 1999
      6. 选路策略
         1. ![BGP选路示意图](../img/net/net-internet-routing-BGP-sample.png)
         2. 假设B直到BAW路径，应该将BAW通告给C吗？这样C可以通过CBAW将流量引导到W
         3. 任何穿越某ISP主干网的流量必须是或其源或摩的（或两者）位于该ISP的某个ISP网络中，否则这些流量将会免费搭乘该ISP的网络
         4. 独立的对等协定通常在ISP双方协商，而且经常对外保密（解决上诉问题）
      7. 参考网站/文章：http://www.routeview.org,\[Huston 2001;Meng 2005]
   4. 为什么有AS间选路协议和AS内部选路协议
      1. 策略：决定一个AS的流量能不能穿过另外一个特定的AS，可能会很重要？？
      2. 规模：
      3. 性能
7. 广播和多播选路
   1. 广播选路算法
      1. 实现：源节点产生该分组的N份拷贝，对不同目的地的每个拷贝进行编址，并用单播选路向N个目的地传输这份拷贝。
      2. 缺点
         1. 效率低
      3. 广播算法
         1. 无控制洪泛：源节点向他的所有邻居发送该分组的拷贝。某节点接收到广播分组，它复制该分组，并向所有邻居转发。但可能因环路导致无限循环，更可能因为转播浪费无限分组
         2. 控制洪泛
            1. 序号控制洪泛：愿节点将其地址（或其他唯一标识）以及广播序号加入广播分组，再向它的邻居转发。每个节点维护它收到的、复制的、转发的的源地址和每个广播分组的序号列表。如果收到重复分组，是则丢弃
            2. 反向路径转发RPF：当路由器收到广播分组时，仅当该分组到达的链路正好是位于它自己到其源的最短单播路径上，他才传输分组，否则将丢弃分组。
            3. RPF示意图![RPF示意图](../img/net/net-internet-routing-RPF.png)
         3. 生成树广播
            1. 虽然控制洪泛避免了广播风波，但仍可能会收到冗余分组
            2. 生成树广播是对网络节点构成一颗生成树。当源节点要发送一个广播分组时，它向所有属于该生成树的特定链路发送分组。接收广播分组的节点则向生成树中的所有邻居转发该分组
         4. 实践中的广播算法
            1. Gnutella
            2. LSA
   2. 多播
      1. 应用：批量数据传输、流式连续媒体、数据共享应用、数据供给如股价、web缓存更新、交互式游戏
      2. 2个问题
         1. 怎么标识多播分组的接收方
            1. 多播数据报使用间接地址来编址，即用一个标识表示一组接收方，寻址到该组的分组的拷贝被交付给所有与该组相关的多播接收方
            2. 因特网中，表示一组接收方的单一标识就是一个D类多播地址。与一个D类地址相关联的接收方组称为一个多播组。
            3. 每台主机都有一个唯一的IP单播地址，该单播地址完全独立于它所参与的多播组的地址
            4. 多播组图例![多播组图例](../img/net/net-internet-routing-multicast-group.png)
            5. 问题：一个组如何形成？如何终结？如果选择组地址？新主机如何加入？加入是否有限制？
         2. 怎么为发送到这些接收方的分组编址
      3. 网络层多播组件：IGMP与多播选路协议
         1. IGMP
            1. IGMP只有3中报文类型，报文封装在IP数据报中，协议号为2
            2. 应用程序通过第一跳路由器向所有与主机相连的接口发送membership_query报文，以确定该接口上的主机已加入的所有多播组集合
            3. 主机使用membership_report报文来响应。当一个应用程序首次加入一个多播组时，也可以直接由主机发出membership_report报文
            4. 最后一个报文是leave_group报文。这个报文是可选的，当无主机响应一个含有给定组地址的membership_query报文时，路由器就可以推断出没有主机存在在这个多播组了。软状态，而非硬状态
         2. 多播选路算法
            1. 使用一颗组共享树进行多播选路：
            2. 使用一颗基于源的树进行多播选路：
         3. 因特网中的多播选路
            1. 距离向量多播选路协议DVMRP：实现具有反向路径转发与剪枝算法的基于源的树
            2. 协议无关的多播选路协议 PIM：稠密模式类似DVMRP，稀疏模式使用汇合点建立多播分布树。在源特定多么SSM中，仅允许单一发送方向多播树发送流量，大大简化了树的构造和维护
            3. 当PIM和DVMRP在同一个域中时，网络管理员可以配置该域中的IP多播路由器。在RFC4271中，对BGP协议进行了扩展，使之能够为其他协议承载选路信息，包含多播信息
            4. 多播源发现协议MSDP可以在不同的PIM稀疏模式域中将汇合点连接在一起
8. 总结
   1. 网络层是协议栈最具有挑战性的协议

### 网络模型-数据链路层
1. 概述
   1. 2种链路层信道
      1. 广播信道：局域网LAN、无限LAN、卫星网和混合光纤电缆
      2. 点对点通信链路
   2. 术语
      1. 节点：主机或路由器
      2. 链路：沿着通信路径连接相邻节点的通信信道
   3. 链路层协议
      1. 链路层协议用来在独立的链路上移动数据报
      2. 链路层协议定义了在链路两端的节点之间交互的分组格式，以及当发送和接收分组时，这些节点采取的动作（包含检测、重传、流量控制和随即接入）
      3. 链路层协议包含以太网、802.11无限LAN（WiFi）、令牌环和PPP。很多场合下，ATM也被认为是链路层协议
      4. 链路层协议的任务是将网络层的数据报通过路径中的单段链路节点到节点地传送，数据报在路径中的不同链路可能由不同的链路层协议承载。就像一趟出行，同时使用了大巴、火车、飞机等交通工具
      5. 提供的服务包含
         1. 成帧：几乎所有的俩路层协议都在经链路传送之前，将每个网络层数据报用链路层帧封装起来。一个帧由一个数据字段（网络层数据报）个若干首部字段（首部字段+可能有的尾部字段）组成。
         2. 链路接入：媒体访问控制MAC协议规定了帧在链路上传输的规则
         3. 可靠交付：当链路层协议提供可靠交付服务时，它保证无差错的将链路层移动每个网络层数据报。当然，许多链路层协议不提供可靠交付服务。
         4. 流量控制：链路每一端的节点都具有有限容量的帧缓存能力。链路层协议能够提供流量控制，以防止链路一端的发送节点淹没另一端的接收节点
         5. 差错检测：因为信号衰减和电磁噪声，可能导致比特差错。差错检测类似校验和，但是通常更复杂，而且用硬件实现。
         6. 差错纠正：类似差错检测，额外提供了纠正差错的功能
         7. 半双工和全双工：前者不能同时传输和接收，后者链路两端的节点可以同时传输分组。
   4. 链路层实现
      1. ![链路层物理结构.png](../img/net/net-layer-network-adapter.png)
      2. 网络适配器，又称为网络接口卡NIC，它的内核是链路层控制器（是现实了许多链路层服务的单个特定目的的芯片）。早期的网络适配器还是物理上分离的卡，如今大都被综合到主机的主板
      3. CPU执行的功能：发送端从网络层接收数据报、装配链路层寻址信息、激活控制器硬件，接收段响应来自控制器的终端、处理差错情况、将数据上报给网络层
      4. ![链路层发送方和接收方.png](../img/net/net-layer-network-adapter-two.png)
2. 差错检测和纠错技术
   1. 奇偶校验：用来描述差错检测和纠错隐含的基本思想
      1. 假设要发送的信息D中有d个比特，在校验和方案中，发送方只需包含一个附加的比特。选择它的值，是的d+1个比特中1的总数是偶数（奇校验方案选择校验使得有奇数个1）
      2. 使用上述校验方案未检测差错的概率能够达到50%
      3. 将d比特划分为i行j列，对每行和每列计算奇偶值，差生i+j+1奇偶比特构成链路层帧的差错检测比特
      4. 接收方检测和纠正差错的能力称为前向纠错FEC
   2. 校验和方法：更多的用于运输层
   3. 循环冗余检测CRC：更多的用于适配器中的链路层
      1. CRC编码也称为多项式编码，因为该编码能够将要发送的比特串看错是系统为0和1的多项式，对比特串的操作解释为多项式算术
      2. 假设发送d比特的数据没发送方必须协商一个r+1的比特模式，称为生成多项式，以G表示。发送方选择r个附加比特，是的d+r比特模式用模2算术恰好被G整除
      3. ...看不懂？？？
3. 多路访问协议
   1. 
### 网络模型-物理层


### TCP/IP
1. MSS:TCP报文最大长度，超过次长度将分段
2. MTC：IP报文最大长度，超过此长度将分片
3. ip地址：
    1. 网络号：标识ip属于那个子网
    2. 主机号：标识是子网下那一台主机
4. 路由：
5. 数据链路层：标识网络中的设备，为网络层提供提供链路级别传输的服务
6. 物理层： 当数据准备要从设备发送到网络时，需要把数据包转换成电信号，让其可以在物理介质中传输，这一层就是物理层 (Physical Layer)，它主要是为数据链路层提供二进制传输的服务

### TCP


### UDP
1. 

### HTTP
1. 概念：HyperText Transfer Protocol 超文本传输协议

### Telnet
1. 由RFC854定义
2. 用于远程登录的应用层协议
3. 基于TCP
4. 未加密
5. 回显

### 发展历史：
- 1961-1972：分组交换
- 1972-1980: 专用网络和网络互联
- 1980-1990： 网络激增
- 20世纪90年代：因特网爆炸
